package com.example.nostalgiaapp;

import javafx.scene.layout.StackPane;
import javafx.scene.input.MouseEvent;
import javafx.scene.Cursor;
import java.io.File;
import java.net.MalformedURLException;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.layout.*;
import javafx.scene.paint.Color;
import javafx.scene.shape.Circle;
import javafx.scene.text.Font;
import javafx.scene.text.FontWeight;
import javafx.scene.text.Text;
import javafx.stage.Stage;
import java.util.ArrayList;
import java.util.List;
import javafx.scene.effect.ColorAdjust;

public class PhotoEditingPage extends BorderPane {


    private List<ImageView> stickerViews; // Track placed stickers
    private String selectedSticker = null; // Currently selected sticker
    private boolean stickerMode = false;
    private VBox photostripPreview;
    private HBox horizontalPhotostripPreview;
    private VBox photostripBackgroundVertical;
    private VBox photostripBackgroundHorizontal;
    private List<ImageView> photoImages;
    private List<Image> sourceImages;
    private boolean isVerticalLayout = true;
    private Color selectedBackgroundColor = Color.WHITE;
    private Color selectedPhotostripColor = Color.web("#ADD8E6"); // Light blue as shown in image
    private String selectedFilter = "no-filter";
    private boolean enableDate = true;
    private Stage currentStage;
    private NostalgiaApp mainApp;

    // Layout selection buttons for highlighting
    private Button verticalLayoutBtn;
    private Button horizontalLayoutBtn;

    // Color options matching the design
    private final Color[] backgroundColorOptions = {
            Color.BLACK, Color.BLUE, Color.web("#8B4513"), Color.LIGHTGRAY,
            Color.HOTPINK, Color.GOLD, Color.LIGHTPINK, Color.WHITE
    };

    private final Color[] photostripColorOptions = {
            Color.BLACK, Color.BLUE, Color.web("#8B4513"), Color.WHITE,
            Color.HOTPINK, Color.GOLD, Color.LIGHTPINK, Color.LIGHTGRAY
    };

    // Filter options
    private final String[] filterOptions = {
            "B&W", "Bright", "Sepia", "Warm", "Cold"
    };

    // Sticker options (placeholder emojis)
    private final String[] stickerOptions = {
            "üß†", "üåç", "üêØ", "‚ùå", "üåü", "‚≠ê", "ü¶Ñ", "üóëÔ∏è"
    };

    public PhotoEditingPage(List<Image> photos, Stage stage, NostalgiaApp mainApp) {
        this.sourceImages = photos != null ? photos : new ArrayList<>();
        this.currentStage = stage;
        this.mainApp = mainApp;
        this.photoImages = new ArrayList<>();

        // Set main background color
        this.setStyle("-fx-background-color: #FFF4C5;");

        initializeComponents();
        setupLayout();
        loadPhotosIntoPreview();
    }

    private void initializeComponents() {

        this.stickerViews = new ArrayList<>();
        // Create header
        HBox header = createHeader();
        this.setTop(header);

        // Create main content
        HBox mainContent = createMainContent();
        this.setCenter(mainContent);
    }

    private HBox createHeader() {
        HBox header = new HBox();
        header.setAlignment(Pos.CENTER_RIGHT);
        header.setPadding(new Insets(15, 25, 15, 25));
        header.setStyle("-fx-background-color: #FFF4C5;");

        // Home button
        Button homeBtn = new Button("üè†");
        homeBtn.setStyle("-fx-background-color: transparent; -fx-font-size: 24px; -fx-text-fill: #8B4513;");
        homeBtn.setOnAction(e -> handleHomeButton());

        // Title
        Text title = new Text("Nostalgia");
        title.setFont(Font.font("Brush Script MT", FontWeight.NORMAL, 32));
        title.setFill(Color.web("#8B4513"));

        Region spacer = new Region();
        HBox.setHgrow(spacer, Priority.ALWAYS);

        header.getChildren().addAll(homeBtn, spacer, title);
        return header;
    }

    private HBox createMainContent() {
        HBox mainContent = new HBox(30);
        mainContent.setPadding(new Insets(20, 40, 20, 40));
        mainContent.setAlignment(Pos.TOP_CENTER);

        // Left side - Photo preview
        VBox leftSide = createPhotoPreviewSection();

        // Right side - Controls
        VBox rightSide = createControlsSection();

        mainContent.getChildren().addAll(leftSide, rightSide);
        return mainContent;
    }

    private VBox createPhotoPreviewSection() {
        VBox leftSide = new VBox(20);
        leftSide.setAlignment(Pos.TOP_CENTER);
        leftSide.setPrefWidth(450);

        createPhotostripPreviews();

        // Initially show vertical layout
        leftSide.getChildren().add(photostripBackgroundVertical);

        return leftSide;
    }

    private void createPhotostripPreviews() {
        // Create background containers for photostrips using StackPane for layering
        StackPane photostripContainerVertical = new StackPane();
        photostripContainerVertical.setAlignment(Pos.CENTER);
        photostripContainerVertical.setPadding(new Insets(15));
        photostripContainerVertical.setStyle("-fx-background-color: white; -fx-background-radius: 15; " +
                "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.2), 10, 0.5, 2, 2);");

        StackPane photostripContainerHorizontal = new StackPane();
        photostripContainerHorizontal.setAlignment(Pos.CENTER);
        photostripContainerHorizontal.setPadding(new Insets(15));
        photostripContainerHorizontal.setStyle("-fx-background-color: white; -fx-background-radius: 15; " +
                "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.2), 10, 0.5, 2, 2);");

        // Create photostrip backgrounds
        photostripBackgroundVertical = new VBox();
        photostripBackgroundVertical.setAlignment(Pos.CENTER);
        photostripBackgroundVertical.setPadding(new Insets(15));
        photostripBackgroundVertical.setStyle("-fx-background-color: white; -fx-background-radius: 15; " +
                "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.2), 10, 0.5, 2, 2);");

        photostripBackgroundHorizontal = new VBox();
        photostripBackgroundHorizontal.setAlignment(Pos.CENTER);
        photostripBackgroundHorizontal.setPadding(new Insets(15));
        photostripBackgroundHorizontal.setStyle("-fx-background-color: white; -fx-background-radius: 15; " +
                "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.2), 10, 0.5, 2, 2);");

        // Vertical photostrip with StackPane for sticker overlay
        StackPane verticalPhotostripStack = new StackPane();
        photostripPreview = new VBox(5);
        photostripPreview.setPadding(new Insets(10));
        photostripPreview.setAlignment(Pos.CENTER);
        photostripPreview.setStyle("-fx-background-color: #ADD8E6; -fx-background-radius: 10;");
        photostripPreview.setPrefWidth(180/2);
        photostripPreview.setMaxWidth(180/2);
        photostripPreview.setPrefHeight(350);
        photostripPreview.setMaxHeight(350);

        // Add click handler for sticker placement
        verticalPhotostripStack.setOnMouseClicked(this::handlePhotostripClick);
        verticalPhotostripStack.getChildren().add(photostripPreview);

        // Horizontal photostrip with StackPane for sticker overlay
        StackPane horizontalPhotostripStack = new StackPane();
        horizontalPhotostripPreview = new HBox(5);
        horizontalPhotostripPreview.setPadding(new Insets(10));
        horizontalPhotostripPreview.setAlignment(Pos.CENTER);
        horizontalPhotostripPreview.setStyle("-fx-background-color: #ADD8E6; -fx-background-radius: 10;");
        horizontalPhotostripPreview.setPrefWidth(380);
        horizontalPhotostripPreview.setMaxWidth(380);
        horizontalPhotostripPreview.setPrefHeight(120);
        horizontalPhotostripPreview.setMaxHeight(120);

        // Add click handler for sticker placement
        horizontalPhotostripStack.setOnMouseClicked(this::handlePhotostripClick);
        horizontalPhotostripStack.getChildren().add(horizontalPhotostripPreview);

        // Add photostrips to their backgrounds
        photostripBackgroundVertical.getChildren().add(verticalPhotostripStack);
        photostripBackgroundHorizontal.getChildren().add(horizontalPhotostripStack);

        // Set the background container sizes
        photostripBackgroundVertical.setPrefWidth(212/2);
        photostripBackgroundVertical.setMaxWidth(212/2);
        photostripBackgroundVertical.setPrefHeight(380);
        photostripBackgroundVertical.setMaxHeight(380);

        photostripBackgroundHorizontal.setPrefWidth(410);
        photostripBackgroundHorizontal.setMaxWidth(410);
        photostripBackgroundHorizontal.setPrefHeight(150);
        photostripBackgroundHorizontal.setMaxHeight(150);
    }


    private VBox createControlsSection() {
        VBox rightSide = new VBox(25);
        rightSide.setPrefWidth(500);
        rightSide.setAlignment(Pos.TOP_LEFT);

        // Layout chooser section
        VBox layoutSection = createLayoutSection();

        // Stickers section
        VBox stickersSection = createStickersSection();

        // Background and Photostrip color sections
        HBox colorsSection = createColorsSection();

        // Filters section
        VBox filtersSection = createFiltersSection();

        // Date and Continue section combined
        HBox dateAndContinueSection = createDateAndContinueSection();

        rightSide.getChildren().addAll(
                layoutSection, stickersSection, colorsSection,
                filtersSection, dateAndContinueSection
        );

        return rightSide;
    }

    private VBox createLayoutSection() {
        VBox layoutSection = new VBox(15);

        Text layoutLabel = new Text("Choose Layout");
        layoutLabel.setFont(Font.font("Arial", FontWeight.BOLD, 16));
        layoutLabel.setFill(Color.web("#333333"));

        HBox layoutOptions = new HBox(20);
        layoutOptions.setAlignment(Pos.CENTER_LEFT);

        // Vertical layout option
        VBox verticalOption = new VBox(8);
        verticalOption.setAlignment(Pos.CENTER);

        // Create vertical layout preview
        VBox verticalPreview = new VBox(2);
        verticalPreview.setAlignment(Pos.CENTER);
        for (int i = 0; i < 4; i++) {
            javafx.scene.shape.Rectangle rect = new javafx.scene.shape.Rectangle(25, 18);
            rect.setFill(Color.BLACK);
            rect.setStroke(Color.GRAY);
            rect.setStrokeWidth(0.5);
            verticalPreview.getChildren().add(rect);
        }

        verticalLayoutBtn = new Button();
        verticalLayoutBtn.setGraphic(verticalPreview);
        verticalLayoutBtn.setPrefSize(50, 90);
        verticalLayoutBtn.setStyle("-fx-background-color: " + (isVerticalLayout ? "#4CAF50" : "white") +
                "; -fx-border-color: #333; -fx-border-width: 2; -fx-background-radius: 5; -fx-cursor: hand;");
        verticalLayoutBtn.setOnAction(e -> switchToVerticalLayout());

        verticalOption.getChildren().add(verticalLayoutBtn);

        // Horizontal layout option
        VBox horizontalOption = new VBox(8);
        horizontalOption.setAlignment(Pos.CENTER);

        // Create horizontal layout preview
        HBox horizontalPreview = new HBox(2);
        horizontalPreview.setAlignment(Pos.CENTER);
        for (int i = 0; i < 3; i++) {
            javafx.scene.shape.Rectangle rect = new javafx.scene.shape.Rectangle(18, 25);
            rect.setFill(Color.BLACK);
            rect.setStroke(Color.GRAY);
            rect.setStrokeWidth(0.5);
            horizontalPreview.getChildren().add(rect);
        }

        horizontalLayoutBtn = new Button();
        horizontalLayoutBtn.setGraphic(horizontalPreview);
        horizontalLayoutBtn.setPrefSize(90, 50);
        horizontalLayoutBtn.setStyle("-fx-background-color: " + (!isVerticalLayout ? "#4CAF50" : "white") +
                "; -fx-border-color: #333; -fx-border-width: 2; -fx-background-radius: 5; -fx-cursor: hand;");
        horizontalLayoutBtn.setOnAction(e -> switchToHorizontalLayout());

        horizontalOption.getChildren().add(horizontalLayoutBtn);

        layoutOptions.getChildren().addAll(verticalOption, horizontalOption);
        layoutSection.getChildren().addAll(layoutLabel, layoutOptions);

        return layoutSection;
    }

    private VBox createStickersSection() {
        VBox stickersSection = new VBox(15);

        Text stickersLabel = new Text("Stickers");
        stickersLabel.setFont(Font.font("Arial", FontWeight.BOLD, 16));
        stickersLabel.setFill(Color.web("#333333"));

        // Create sticker grid
        GridPane stickerGrid = new GridPane();
        stickerGrid.setHgap(12);
        stickerGrid.setVgap(12);

        // Load stickers from resources
        String[] stickerFiles = {
                "axolotl-stickers.svg", // Your main sticker file
                // Add more sticker files here as needed
        };

        for (int i = 0; i < stickerOptions.length && i < stickerFiles.length; i++) {
            Button stickerBtn = new Button();

            try {
                // Load sticker image
                String stickerPath = "/com/example/nostalgiaapp/Stickers/" + stickerFiles[i];
                Image stickerImage = new Image(getClass().getResourceAsStream(stickerPath));
                ImageView stickerView = new ImageView(stickerImage);
                stickerView.setFitWidth(35);
                stickerView.setFitHeight(35);
                stickerView.setPreserveRatio(true);

                stickerBtn.setGraphic(stickerView);
            } catch (Exception e) {
                // Fallback to emoji if image loading fails
                stickerBtn.setText(stickerOptions[i]);
            }

            stickerBtn.setStyle("-fx-font-size: 20px; -fx-background-radius: 50%; -fx-min-width: 45; -fx-min-height: 45; " +
                    "-fx-background-color: white; -fx-border-color: #ddd; -fx-border-width: 1; -fx-border-radius: 50%; -fx-cursor: hand;");

            // Handle sticker selection
            final int stickerIndex = i;
            final String stickerFile = stickerFiles[i];
            stickerBtn.setOnAction(e -> selectSticker(stickerFile, stickerIndex));

            stickerGrid.add(stickerBtn, i % 4, i / 4);
        }

        // Add clear stickers button
        Button clearStickersBtn = new Button("Clear All");
        clearStickersBtn.setStyle("-fx-background-color: #FF6B6B; -fx-text-fill: white; -fx-background-radius: 15; " +
                "-fx-padding: 8 16; -fx-font-weight: bold; -fx-cursor: hand;");
        clearStickersBtn.setOnAction(e -> clearAllStickers());

        stickersSection.getChildren().addAll(stickersLabel, stickerGrid, clearStickersBtn);
        return stickersSection;
    }

    private void selectSticker(String stickerFile, int stickerIndex) {
        selectedSticker = stickerFile;
        stickerMode = true;

        // Visual feedback - show which sticker is selected
        System.out.println("Selected sticker: " + stickerFile);

        // Change cursor to indicate sticker mode
        if (isVerticalLayout) {
            photostripBackgroundVertical.setCursor(Cursor.CROSSHAIR);
        } else {
            photostripBackgroundHorizontal.setCursor(Cursor.CROSSHAIR);
        }
    }

    private void handlePhotostripClick(MouseEvent event) {
        if (stickerMode && selectedSticker != null) {
            placeStickerAt(event.getX(), event.getY());
        }
    }

    private void placeStickerAt(double x, double y) {
        try {
            // Load the selected sticker
            String stickerPath = "/com/example/nostalgiaapp/Stickers/" + selectedSticker;
            Image stickerImage = new Image(getClass().getResourceAsStream(stickerPath));

            ImageView stickerView = new ImageView(stickerImage);
            stickerView.setFitWidth(30); // Adjust size as needed
            stickerView.setFitHeight(30);
            stickerView.setPreserveRatio(true);

            // Position the sticker
            stickerView.setLayoutX(x - 15); // Center the sticker on click point
            stickerView.setLayoutY(y - 15);

            // Make sticker draggable and removable
            makeStickerInteractive(stickerView);

            // Add to the current photostrip container
            StackPane currentContainer = getCurrentPhotostripContainer();
            if (currentContainer != null) {
                currentContainer.getChildren().add(stickerView);
                stickerViews.add(stickerView);
            }

            // Exit sticker mode
            stickerMode = false;
            selectedSticker = null;
            resetCursor();

        } catch (Exception e) {
            System.err.println("Error placing sticker: " + e.getMessage());
            showErrorDialog("Sticker Error", "Unable to place sticker. Please try again.");
        }
    }

    private StackPane getCurrentPhotostripContainer() {
        try {
            VBox leftSide = (VBox) ((HBox) this.getCenter()).getChildren().get(0);
            VBox backgroundContainer = (VBox) leftSide.getChildren().get(0);
            return (StackPane) backgroundContainer.getChildren().get(0);
        } catch (Exception e) {
            System.err.println("Error getting photostrip container: " + e.getMessage());
            return null;
        }
    }

    private void makeStickerInteractive(ImageView stickerView) {
        // Make sticker draggable
        stickerView.setOnMousePressed(e -> {
            stickerView.setUserData(new double[]{e.getSceneX() - stickerView.getLayoutX(),
                    e.getSceneY() - stickerView.getLayoutY()});
        });

        stickerView.setOnMouseDragged(e -> {
            double[] offset = (double[]) stickerView.getUserData();
            stickerView.setLayoutX(e.getSceneX() - offset[0]);
            stickerView.setLayoutY(e.getSceneY() - offset[1]);
        });

        // Right-click to remove sticker
        stickerView.setOnMouseClicked(e -> {
            if (e.getClickCount() == 2) { // Double-click to remove
                StackPane container = getCurrentPhotostripContainer();
                if (container != null) {
                    container.getChildren().remove(stickerView);
                    stickerViews.remove(stickerView);
                }
            }
        });

        // Visual feedback
        stickerView.setOnMouseEntered(e -> stickerView.setOpacity(0.8));
        stickerView.setOnMouseExited(e -> stickerView.setOpacity(1.0));
    }

    private void clearAllStickers() {
        StackPane currentContainer = getCurrentPhotostripContainer();
        if (currentContainer != null) {
            // Remove all stickers from the container
            currentContainer.getChildren().removeAll(stickerViews);
            stickerViews.clear();
        }
    }

    private void resetCursor() {
        if (isVerticalLayout) {
            photostripBackgroundVertical.setCursor(Cursor.DEFAULT);
        } else {
            photostripBackgroundHorizontal.setCursor(Cursor.DEFAULT);
        }
    }



    private HBox createColorsSection() {
        HBox colorsSection = new HBox(40);

        // Background colors
        VBox backgroundSection = createColorSection("Background", backgroundColorOptions, true);

        // Photostrip colors
        VBox photostripSection = createColorSection("Photostrip", photostripColorOptions, false);

        colorsSection.getChildren().addAll(backgroundSection, photostripSection);
        return colorsSection;
    }

    private VBox createColorSection(String title, Color[] colors, boolean isBackground) {
        VBox colorSection = new VBox(15);

        Text colorLabel = new Text(title);
        colorLabel.setFont(Font.font("Arial", FontWeight.BOLD, 16));
        colorLabel.setFill(Color.web("#333333"));

        GridPane colorGrid = new GridPane();
        colorGrid.setHgap(8);
        colorGrid.setVgap(8);

        for (int i = 0; i < colors.length; i++) {
            Circle colorCircle = new Circle(18);
            colorCircle.setFill(colors[i]);
            colorCircle.setStroke(Color.GRAY);
            colorCircle.setStrokeWidth(2);
            colorCircle.setStyle("-fx-cursor: hand;");

            final Color color = colors[i];
            colorCircle.setOnMouseClicked(e -> {
                if (isBackground) {
                    selectedBackgroundColor = color;
                    updateBackgroundColors();
                } else {
                    selectedPhotostripColor = color;
                    updatePhotostripColors();
                }
            });

            colorGrid.add(colorCircle, i % 4, i / 4);
        }

        colorSection.getChildren().addAll(colorLabel, colorGrid);
        return colorSection;
    }

    private VBox createFiltersSection() {
        VBox filtersSection = new VBox(15);

        Text filtersLabel = new Text("Filters");
        filtersLabel.setFont(Font.font("Arial", FontWeight.BOLD, 16));
        filtersLabel.setFill(Color.web("#333333"));

        HBox filterRow1 = new HBox(10);
        filterRow1.setAlignment(Pos.CENTER_LEFT);

        HBox filterRow2 = new HBox(10);
        filterRow2.setAlignment(Pos.CENTER_LEFT);

        for (int i = 0; i < filterOptions.length; i++) {
            Button filterBtn = new Button(filterOptions[i]);
            filterBtn.setStyle("-fx-background-color: #4A4A4A; -fx-text-fill: white; -fx-background-radius: 15; " +
                    "-fx-padding: 8 16; -fx-font-weight: bold; -fx-cursor: hand;");
            filterBtn.setPrefWidth(80);

            final String filter = filterOptions[i];
            filterBtn.setOnAction(e -> {
                selectedFilter = filter;
                applyFilter();
            });

            if (i < 3) {
                filterRow1.getChildren().add(filterBtn);
            } else {
                filterRow2.getChildren().add(filterBtn);
            }
        }

        // Add reset button
        Button resetBtn = new Button("Reset");
        resetBtn.setStyle("-fx-background-color: #FF6B6B; -fx-text-fill: white; -fx-background-radius: 15; " +
                "-fx-padding: 8 16; -fx-font-weight: bold; -fx-cursor: hand;");
        resetBtn.setPrefWidth(80);
        resetBtn.setOnAction(e -> {
            selectedFilter = "no-filter";
            applyFilter();
        });
        filterRow2.getChildren().add(resetBtn);

        filtersSection.getChildren().addAll(filtersLabel, filterRow1, filterRow2);
        return filtersSection;
    }

    // FIXED: Combined date toggle and continue button in one horizontal section
    private HBox createDateAndContinueSection() {
        HBox dateAndContinueSection = new HBox(20);
        dateAndContinueSection.setAlignment(Pos.CENTER_LEFT);

        // Date toggle
        ToggleButton dateSwitch = new ToggleButton();
        dateSwitch.setText("GENERATE DATE");
        dateSwitch.setSelected(enableDate);
        dateSwitch.setStyle("-fx-background-color: #FF8C00; -fx-text-fill: white; -fx-background-radius: 20; " +
                "-fx-padding: 10 20; -fx-font-weight: bold; -fx-cursor: hand;");

        dateSwitch.setOnAction(e -> {
            enableDate = dateSwitch.isSelected();
            updateDateDisplay();
        });

        // Continue button
        Button continueBtn = new Button("CONTINUE");
        continueBtn.setStyle("-fx-background-color: #87CEEB; -fx-text-fill: white; -fx-font-weight: bold; " +
                "-fx-background-radius: 10; -fx-padding: 12 25; -fx-font-size: 14px; -fx-cursor: hand;");

        continueBtn.setOnAction(e -> {
            Alert alert = new Alert(Alert.AlertType.INFORMATION);
            alert.setTitle("Continue Not Available");
            alert.setHeaderText(null);
            alert.setContentText("Continue functionality is not yet implemented. This will proceed to the next step in a future update.");
            alert.showAndWait();
        });

        dateAndContinueSection.getChildren().addAll(dateSwitch, continueBtn);
        return dateAndContinueSection;
    }

    private void setupLayout() {
        updatePhotostripLayout();
    }

    private void loadPhotosIntoPreview() {
        photoImages.clear();

        try {
            int photoCount = isVerticalLayout ? Math.min(4, sourceImages.size()) : Math.min(3, sourceImages.size());

            for (int i = 0; i < photoCount; i++) {
                ImageView imageView = new ImageView();

                if (i < sourceImages.size() && sourceImages.get(i) != null) {
                    imageView.setImage(sourceImages.get(i));
                } else {
                    // Create placeholder if no image available
                    imageView.setStyle("-fx-background-color: lightgray;");
                }

                imageView.setPreserveRatio(true);
                imageView.setSmooth(true);

                if (isVerticalLayout) {
                    imageView.setFitWidth(250);
                    imageView.setFitHeight(85);
                } else {
                    imageView.setFitWidth(140);
                    imageView.setFitHeight(100);
                }

                photoImages.add(imageView);
            }

            updatePhotostripLayout();

        } catch (Exception e) {
            System.err.println("Error loading photos into preview: " + e.getMessage());
            showErrorDialog("Photo Loading Error", "Unable to load photos for editing. Please try again.");
        }
    }

    private void switchToVerticalLayout() {
        if (!isVerticalLayout) {
            // Save current stickers before switching
            List<ImageView> currentStickers = new ArrayList<>(stickerViews);

            isVerticalLayout = true;
            updateLayoutButtons();
            loadPhotosIntoPreview();

            // Switch preview display
            VBox leftSide = (VBox) ((HBox) this.getCenter()).getChildren().get(0);
            leftSide.getChildren().clear();
            leftSide.getChildren().add(photostripBackgroundVertical);

            // Restore stickers to new layout
            restoreStickers(currentStickers);
        }
    }


    private void switchToHorizontalLayout() {
        if (isVerticalLayout) {
            // Save current stickers before switching
            List<ImageView> currentStickers = new ArrayList<>(stickerViews);

            isVerticalLayout = false;
            updateLayoutButtons();
            loadPhotosIntoPreview();

            // Switch preview display
            VBox leftSide = (VBox) ((HBox) this.getCenter()).getChildren().get(0);
            leftSide.getChildren().clear();
            leftSide.getChildren().add(photostripBackgroundHorizontal);

            // Restore stickers to new layout
            restoreStickers(currentStickers);
        }
    }

    private void restoreStickers(List<ImageView> stickers) {
        StackPane currentContainer = getCurrentPhotostripContainer();
        if (currentContainer != null && !stickers.isEmpty()) {
            // Clear existing stickers
            stickerViews.clear();

            // Add saved stickers to new container
            for (ImageView sticker : stickers) {
                // Adjust position for different layout if needed
                currentContainer.getChildren().add(sticker);
                stickerViews.add(sticker);
            }
        }
    }

    private void updateLayoutButtons() {
        verticalLayoutBtn.setStyle("-fx-background-color: " + (isVerticalLayout ? "#4CAF50" : "white") +
                "; -fx-border-color: #333; -fx-border-width: 2; -fx-background-radius: 5; -fx-cursor: hand;");
        horizontalLayoutBtn.setStyle("-fx-background-color: " + (!isVerticalLayout ? "#4CAF50" : "white") +
                "; -fx-border-color: #333; -fx-border-width: 2; -fx-background-radius: 5; -fx-cursor: hand;");
    }

    // FIXED: Updated layout method to properly position date in horizontal layout
    private void updatePhotostripLayout() {
        if (isVerticalLayout) {
            photostripPreview.getChildren().clear();

            // Add photo frames vertically
            for (ImageView photo : photoImages) {
                photostripPreview.getChildren().add(photo);
            }

            // Add date if enabled (at the bottom for vertical layout)
            if (enableDate) {
                Text dateLabel = new Text(java.time.LocalDate.now().format(
                        java.time.format.DateTimeFormatter.ofPattern("MMM dd, yyyy")));
                dateLabel.setStyle("-fx-font-size: 12px; -fx-fill: #333;");
                photostripPreview.getChildren().add(dateLabel);
            }
        } else {
            // FIXED: Clear and rebuild horizontal layout properly
            horizontalPhotostripPreview.getChildren().clear();

            // Create a VBox to hold photos and date separately
            VBox horizontalContainer = new VBox(5);
            horizontalContainer.setAlignment(Pos.CENTER);

            // Create HBox for photos
            HBox photoContainer = new HBox(5);
            photoContainer.setAlignment(Pos.CENTER);

            // Add photo frames horizontally
            for (ImageView photo : photoImages) {
                photoContainer.getChildren().add(photo);
            }

            horizontalContainer.getChildren().add(photoContainer);

            // Add date if enabled (at the center bottom for horizontal layout)
            if (enableDate) {
                Text dateLabel = new Text(java.time.LocalDate.now().format(
                        java.time.format.DateTimeFormatter.ofPattern("MMM dd, yyyy")));
                dateLabel.setStyle("-fx-font-size: 12px; -fx-fill: #333;");
                horizontalContainer.getChildren().add(dateLabel);
            }

            horizontalPhotostripPreview.getChildren().add(horizontalContainer);
        }
    }

    private void updateBackgroundColors() {
        String bgColor = colorToHex(selectedBackgroundColor);

        if (isVerticalLayout) {
            photostripBackgroundVertical.setStyle("-fx-background-color: " + bgColor + "; -fx-background-radius: 15; " +
                    "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.2), 10, 0.5, 2, 2);");
        } else {
            photostripBackgroundHorizontal.setStyle("-fx-background-color: " + bgColor + "; -fx-background-radius: 15; " +
                    "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.2), 10, 0.5, 2, 2);");
        }
    }

    private void updatePhotostripColors() {
        String stripColor = colorToHex(selectedPhotostripColor);

        if (isVerticalLayout) {
            photostripPreview.setStyle("-fx-background-color: " + stripColor + "; -fx-background-radius: 10;");
        } else {
            horizontalPhotostripPreview.setStyle("-fx-background-color: " + stripColor + "; -fx-background-radius: 10;");
        }
    }

    // FIXED: Enhanced filter application with proper CSS effects
    private void applyFilter() {
        // Apply selected filter to all photos
        for (ImageView photo : photoImages) {
            ColorAdjust colorAdjust = null;

            switch (selectedFilter) {
                case "B&W":
                    colorAdjust = new ColorAdjust();
                    colorAdjust.setSaturation(-1.0); // Remove all saturation for black and white
                    break;
                case "Bright":
                    colorAdjust = new ColorAdjust();
                    colorAdjust.setBrightness(0.4); // Increase brightness
                    break;
                case "Sepia":
                    colorAdjust = new ColorAdjust();
                    colorAdjust.setHue(0.1); // Slight brown hue
                    colorAdjust.setSaturation(0.2); // Reduce saturation slightly
                    colorAdjust.setBrightness(0.1); // Slight brightness increase
                    break;
                case "Warm":
                    colorAdjust = new ColorAdjust();
                    colorAdjust.setHue(0.1); // Warmer hue (towards red/orange)
                    colorAdjust.setSaturation(0.2); // Increase saturation slightly
                    colorAdjust.setBrightness(-0.05); // Slightly darker
                    break;
                case "Cold":
                    colorAdjust = new ColorAdjust();
                    colorAdjust.setHue(-0.2); // Cooler hue (towards blue)
                    colorAdjust.setSaturation(-0.1); // Reduce saturation slightly
                    colorAdjust.setBrightness(0.05); // Slightly brighter
                    break;
                case "no-filter":
                default:
                    colorAdjust = null; // No filter - remove effect
                    break;
            }

            // Apply the filter effect
            photo.setEffect(colorAdjust);

            // Clear any CSS styles that might interfere
            photo.setStyle("");
        }

        // Debug output to verify filter application
        System.out.println("Applied filter: " + selectedFilter);
    }

    private void updateDateDisplay() {
        updatePhotostripLayout(); // Refresh the layout to show/hide date
    }

    private void handleStickerSelection() {
        // This method is no longer used as sticker functionality is handled in createStickersSection
    }

    private void handleContinue() {
        // This method is no longer used as continue functionality is handled in createActionButtons
    }

    private void handleHomeButton() {
        try {
            if (mainApp != null) {
                currentStage.close();
                mainApp.showMainWindow();
            } else {
                System.exit(0);
            }
        } catch (Exception e) {
            System.err.println("Error returning to home: " + e.getMessage());
        }
    }

    private String colorToHex(Color color) {
        return String.format("#%02X%02X%02X",
                (int) (color.getRed() * 255),
                (int) (color.getGreen() * 255),
                (int) (color.getBlue() * 255));
    }

    private void showErrorDialog(String title, String message) {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(message);
        alert.showAndWait();
    }
}